@startuml
!theme plain

title Remote_Controls_v2 Interactions (Improved)
autonumber

actor "User" as User
participant "Mobile App" as App
participant "Cloud API" as API
participant "Vehicle" as Vehicle
database "DB" as DB

skinparam sequence {
    ParticipantBorderColor #555555
    ParticipantBackgroundColor #EEEEEE
    ArrowColor #333333
    LifeLineBorderColor #AAAAAA
}

group Lock / Unlock Doors (FR-RMC-001, FR-RMC-002, FR-RMC-010)

    User -> App: Taps "Lock"
    App -> API: POST /vehicles/{id}/command/lock
    note right of API: Command is queued for execution

    API ->> Vehicle: execute_lock()
    API --> App: 202 Accepted

    alt Successful Execution
        Vehicle --> API: command_success(is_locked: true)
        API -> DB: UPDATE vehicles SET is_locked = true
        API ->> App: PUSH_NOTIFICATION(status: "locked")
        App -> App: Provide Haptic Feedback (FR-RMC-010)
        App --> User: Display "Vehicle Locked"

    else Business Logic Failure (e.g., Door ajar)
        Vehicle --> API: command_failed(reason: "door_ajar")
        API ->> App: PUSH_NOTIFICATION(status: "lock_failed", \nreason: "A door may be open.")
        App --> User: Display "Lock Failed: A door may be open."
    end
end

group Climate Preconditioning (FR-RMC-003 to FR-RMC-007)

    User -> App: Taps "Start Climate" \n(sets temp, seats, defrosters)
    App -> API: GET /vehicles/{id}/state
    API -> DB: SELECT is_plugged_in, battery_level FROM vehicles
    DB --> API: is_plugged_in: false, battery_level: 35%
    API --> App: 200 OK {state}

    opt FR-RMC-007: Vehicle is not plugged in and battery is not critical
        App --> User: Display Warning: "Vehicle not plugged in.\nThis will consume battery range. Continue?"
        User -> App: Confirms "Continue"
    end

    App -> API: POST /vehicles/{id}/command/precondition\n{temp: 21, heated_seats: "on", ...}

    alt Sufficient Battery for Preconditioning
        API ->> Vehicle: execute_precondition(settings)
        API --> App: 202 Accepted

        Vehicle --> API: command_success(hvac_status: "on")
        API -> DB: UPDATE vehicles SET hvac_status = 'on', ...
        API ->> App: PUSH_NOTIFICATION(status: "climate_on")
        App --> User: Display "Climate Control Activated"

    else Business Logic Failure (Critically Low Battery)
        API --> App: 409 Conflict\n{error: "critically_low_battery"}
        App --> User: Display "Command Failed:\nBattery is critically low."
    end
end

group Open Trunk / Frunk (FR-RMC-008)

    User -> App: Taps "Open Frunk"
    App -> API: POST /vehicles/{id}/command/open_frunk

    alt Pre-condition Met (Vehicle is stationary)
        API ->> Vehicle: execute_open_frunk()
        API --> App: 202 Accepted

        Vehicle --> API: command_success(frunk_open: true)
        API -> DB: UPDATE vehicles SET frunk_open = true
        API ->> App: PUSH_NOTIFICATION(status: "frunk_open")
        App --> User: Display "Frunk is Open"

    else Business Logic Failure (Vehicle is moving)
        API -> API: Pre-condition check failed (vehicle is not in 'park')
        API --> App: 400 Bad Request\n{error: "vehicle_in_motion"}
        App --> User: Display "Cannot open while vehicle is in motion."
    end
end

group Honk Horn / Flash Lights (FR-RMC-009)

    User -> App: Taps "Honk & Flash"
    App -> API: POST /vehicles/{id}/command/honk_flash

    alt Successful Command
        API ->> Vehicle: execute_honk_flash()
        API --> App: 202 Accepted

        Vehicle --> API: command_success()
        API ->> App: PUSH_NOTIFICATION(status: "honk_flash_activated")
        App --> User: Display "Horn & Lights Activated"

    else API / Vehicle Communication Error
        API --> App: 503 Service Unavailable
        App --> User: Display "Command Failed. Cannot reach vehicle."
    end
end
@enduml