@startuml
!theme sketchy-outline

title Home_Screen_Vehicle_Status_v2 Interactions (Improved)

autonumber

actor "User" as User
participant "VehicleConnect App" as App
participant "LocalSettings" as LocalSettings
participant "Backend API" as API
participant "Vehicle Cloud" as Cloud

group Initial App Load
    User -> App: Launches or foregrounds the application
    activate App
    App -> App: Initiate fetch for latest vehicle status
end

group User-Initiated Refresh
    User -> App: Pull-to-refresh home screen
    activate App
    App -> App: Show loading indicator
end

alt Network Connection Available

    App -> API: GET /vehicle/status
    activate API

    API -> Cloud: Request latest vehicle data
    activate Cloud
    Cloud --> API: Return latest vehicle status record
    deactivate Cloud

    alt Happy Path: Successful & Fresh Status Fetch
        API --> App: 200 OK \n{ "soc": 85, "range_km": 402, "locked": true, "temp_c": 21, ... }
        deactivate API

        App -> LocalSettings: getUnitPreferences()
        note right of App: Addresses FR-USR-001
        activate LocalSettings
        LocalSettings --> App: { "distance": "miles", "temp": "째F" }
        deactivate LocalSettings

        App -> App: Format status data using user preferences \n(e.g., convert km to miles, 째C to 째F)
        note right of App: Addresses FR-HSS-003

        App -> User: Display updated Home Screen \n(SoC, range in miles, lock status, temp in 째F, etc.) \n(FR-HSS-001 to FR-HSS-008)

    else Sad Path: API Error or Stale Data
        alt API cannot reach Vehicle Cloud
            API --> App: 503 Service Unavailable
        else Data in Cloud is stale (older than 60s)
            API --> App: 200 OK with stale data flag \n{ "status": "stale", "last_updated": "...", ... }
            note right of API: As per NFR-PERF-002
        end
        deactivate API

        App -> App: Display "Failed to update status" message
        App -> App: Display cached vehicle data with "last updated" timestamp
        note right of App: As per NFR-REL-002
        App -> User: Show Home Screen with cached data and error indicator
    end

else No Network Connectivity on Device

    App -> App: Detects no network connection
    App -> User: Display "Device is Offline" message
    App -> App: Display cached vehicle data with "last updated" timestamp
    note right of App: As per NFR-REL-002
    App -> User: Show Home Screen with cached data and offline indicator

end

deactivate App

@enduml