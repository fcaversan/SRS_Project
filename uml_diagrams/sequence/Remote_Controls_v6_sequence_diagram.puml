@startuml
!theme plain

title Remote_Controls_v6 Interactions (Improved based on QA Feedback)
autonumber

actor "User" as User
participant "Mobile App" as App
participant "Auth Service" as AuthService
participant "Remote Control System\n(Cloud API)" as API
participant "Vehicle" as Vehicle
database "DB" as DB

skinparam sequence {
    ParticipantBorderColor #555555
    ParticipantBackgroundColor #EEEEEE
    ArrowColor #333333
    LifeLineBorderColor #AAAAAA
}

group Authentication
    User -> App: Enters Credentials and Taps "Login"
    App -> AuthService: POST /auth/token {credentials}
    activate AuthService
    AuthService -> AuthService: Validate Credentials
    AuthService --> App: 200 OK {authToken}
    deactivate AuthService
    App -> App: Store authToken securely
end

group App Initialization & Feature Discovery (QA Rec #4)
    App -> API: GET /vehicles/{id}/details
    note right of App: Includes `Authorization: Bearer {authToken}` header
    activate API
    API -> DB: SELECT configuration, features, state FROM vehicles
    DB --> API: {config, features: ["heated_seats", "frunk"], state: "PARKED"}
    API --> App: 200 OK {vehicle_details}
    deactivate API
    App -> App: Cache vehicle configuration & state
    App -> App: Dynamically render UI controls based on features
end

group Lock / Unlock Doors (FR-RMC-001, FR-RMC-002, FR-RMC-010)
    User -> App: Taps "Lock"
    App -> API: POST /vehicles/{id}/command/lock
    activate API
    API -> API: Authorize request
    API ->> Vehicle: execute_lock()
    API --> App: 202 Accepted (Command Queued)
    deactivate API

    alt Successful Execution
        Vehicle --> API: PUSH command_status(SUCCESS)
        activate API
        API -> DB: UPDATE vehicles SET is_locked = true
        API ->> App: PUSH_NOTIFICATION(status: "locked")
        deactivate API
        App -> App: Provide Haptic Feedback (FR-RMC-010)
        App --> User: Display "Vehicle Locked"

    else Business Logic Failure (e.g., Door ajar)
        Vehicle --> API: PUSH command_status(FAILURE, "door_ajar")
        activate API
        API ->> App: PUSH_NOTIFICATION(status: "lock_failed", \nreason: "A door may be open.")
        deactivate API
        App --> User: Display "Lock Failed: A door may be open."

    else Network Timeout
        activate API
        API -> API: Timeout waiting for vehicle response
        API -> DB: UPDATE command_queue SET status = 'timeout'
        API ->> App: PUSH_NOTIFICATION(status: "command_timeout", \nreason: "Vehicle is unresponsive.")
        deactivate API
        App --> User: Display "Command Failed: Vehicle is offline."
    end
end

group Climate Preconditioning (FR-RMC-003 to FR-RMC-007)
    User -> App: Taps "Start Climate" \n(configures settings)
    App -> API: GET /vehicles/{id}/state
    activate API
    API -> DB: SELECT is_plugged_in, battery_level FROM vehicles
    DB --> API: is_plugged_in: false, battery_level: 35%
    API --> App: 200 OK {state}
    deactivate API

    opt FR-RMC-007: Vehicle is not plugged in
        App --> User: Display Warning: "Vehicle not plugged in.\nThis will consume battery range. Continue?"
        User -> App: Confirms "Continue"
    end

    App -> API: POST /vehicles/{id}/command/precondition \n{climate_settings}
    activate API
    note left of API
      { "target_temp": 21, "heated_elements": { "seats_front": "HIGH",
      "steering_wheel": "ON" }, "defrosters": { "front": "ON" } }
    endnote

    API -> DB: SELECT features, battery_level, vehicle_state FROM vehicles
    DB --> API: {features: ["heated_seats"], battery_level: 35%, vehicle_state: "PARKED"}
    API -> API: Validate request against Vehicle State Machine & config
    note left of API: Precondition command is only valid in 'PARKED' state (QA Rec #1)

    alt Command is Valid (Correct State, Sufficient Battery & Features Equipped)
        API ->> Vehicle: execute_precondition(climate_settings)
        API --> App: 202 Accepted
        deactivate API

        Vehicle --> API: PUSH command_status(SUCCESS, hvac_status: "on")
        activate API
        API -> DB: UPDATE vehicles SET hvac_status = 'on', ...
        API ->> App: PUSH_NOTIFICATION(status: "climate_on")
        deactivate API
        App --> User: Display "Climate Control Activated"

    else Invalid State
        API --> App: 409 Conflict {error: "invalid_vehicle_state", \nrequired: "PARKED", current: "DRIVING"}
        deactivate API
        App --> User: Display "Failed: Cannot start climate \nwhile vehicle is in motion."

    else Invalid Parameters (Feature Not Equipped)
        note left of API: Based on features discovered at initialization (QA Rec #4)
        API --> App: 422 Unprocessable Entity \n{error: "feature_not_equipped", feature: "heated_steering_wheel"}
        deactivate API
        App --> User: Display "Failed: Heated steering wheel\n is not available on this vehicle."
    end
end

group Open Trunk / Frunk (FR-RMC-008)
    User -> App: Taps "Open Frunk"
    App -> API: POST /vehicles/{id}/command/open_frunk
    activate API

    API -> DB: SELECT vehicle_state FROM vehicles WHERE id={id}
    DB --> API: {vehicle_state: "PARKED"}
    API -> API: Validate Pre-condition against Vehicle State Machine (QA Rec #1)
    note right of API: 'open_frunk' command requires 'PARKED' state.

    alt Pre-condition Met (Vehicle is PARKED)
        API ->> Vehicle: execute_open_frunk()
        API --> App: 202 Accepted
        deactivate API

        Vehicle --> API: PUSH command_status(SUCCESS, frunk_open: true)
        activate API
        API -> DB: UPDATE vehicles SET frunk_open = true
        API ->> App: PUSH_NOTIFICATION(status: "frunk_open")
        deactivate API
        App --> User: Display "Frunk is Open"

    else Pre-condition Failed (Vehicle not PARKED)
        API --> App: 409 Conflict {error: "invalid_vehicle_state", reason: "vehicle_in_motion"}
        deactivate API
        App --> User: Display "Cannot open while vehicle is in motion."
    end
end

group Honk Horn / Flash Lights (FR-RMC-009)
    User -> App: Taps "Honk & Flash"
    App -> API: POST /vehicles/{id}/command/honk_flash
    activate API
    API ->> Vehicle: execute_honk_flash()
    note right of Vehicle: Internally invokes honkHorn() & flashLights() \non ExteriorAlertSystem (QA Rec #3)
    API --> App: 202 Accepted
    deactivate API

    alt Successful Execution
        Vehicle --> API: PUSH command_status(SUCCESS)
        activate API
        API ->> App: PUSH_NOTIFICATION(status: "honk_flash_activated")
        deactivate API
        App --> User: Display "Horn & Lights Activated"

    else Command Failure
        Vehicle --> API: PUSH command_status(FAILURE)
        activate API
        API ->> App: PUSH_NOTIFICATION(status: "honk_flash_failed")
        deactivate API
        App --> User: Display "Command Failed. Please try again."
    end
end
@enduml