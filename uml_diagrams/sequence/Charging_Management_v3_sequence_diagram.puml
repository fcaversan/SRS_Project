@startuml
!theme plain
title Charging_Management_v3 Interactions (Improved)

autonumber

actor User
participant App
participant API as "API Gateway (ChargingManager Facade)"
participant VehicleGateway as "Vehicle Gateway"
database DB
participant ChargingStationFinder as "Charging Station Finder"

group Remote Charging Control (FR-CHG-001, FR-CHG-002)

    User -> App: Tap "Start Charging"
    App -> API: POST /vehicles/{id}/commands/start_charge
    note right of API: Asynchronous command pattern for vehicle interaction
    API -> API: Validate request and user permissions
    API -> VehicleGateway: GetVehicleStatus(vehicleId)
    VehicleGateway --> API: Return { is_plugged_in: true, state: 'ready' }

    alt Vehicle is ready to charge
        API -> VehicleGateway: SendCommand(vehicleId, 'start_charge')
        API -> App: 202 Accepted (Command enqueued)
        App -> User: Display "Starting charging session..."

        loop Poll for status update (every 5s for 30s)
            App -> API: GET /vehicles/{id}/state/charge
            API --> App: 200 OK (DTO: { state: 'charging' })
            App -> App: Update UI to "Charging" state
            break
        end

    else Vehicle not ready (e.g., not plugged in)
        API -> App: 409 Conflict (Error: Not plugged in)
        App -> User: Display error: "Vehicle is not plugged into a compatible charger."
    end

    ...5 minutes later...

    User -> App: Tap "Stop Charging"
    App -> API: POST /vehicles/{id}/commands/stop_charge
    API -> VehicleGateway: SendCommand(vehicleId, 'stop_charge')
    alt Command accepted by vehicle
        API -> App: 202 Accepted (Command enqueued)
        App -> User: Display "Stopping charging session..."
        note right of App: App will poll for status update to confirm session stopped.
    else Command failed
        API -> App: 500 Internal Server Error
        App -> User: Display error: "Failed to stop charging session."
    end
end

group Monitor Active Charging Session (FR-CHG-003)
    User -> App: View charging screen
    loop Periodically (e.g., every 15s)
        App -> API: GET /vehicles/{id}/state/charge
        alt API responds with data
            API -> App: 200 OK (DTO: {soc, time_to_full, rate_kw, voltage, amperage, state: 'charging'})
            App -> User: Update display with SoC, ETA, rate, etc.
        else API request fails
            API -> App: 503 Service Unavailable
            App -> User: Display stale data with "Could not refresh status" message
        end
    end
    note across App, API: For real-time updates, a WebSocket connection would be more efficient than HTTP polling.
end

group Manage Charging Settings (FR-CHG-004)
    User -> App: Open "Charging Settings"
    App -> API: GET /vehicles/{id}/settings/charge
    API -> DB: Query for current charge limit
    DB --> API: Return current setting (e.g., 80%)
    API -> App: 200 OK (JSON: {daily_limit: 80})
    App -> User: Display charge limit slider (default 80%)

    User -> App: Set new daily charge limit (e.g., 90%)
    App -> API: PUT /vehicles/{id}/settings/charge (body: {daily_limit: 90})
    API -> DB: Update charge limit for vehicle
    DB --> API: Confirm update
    API -> App: 200 OK
    App -> User: Display "Daily charge limit updated to 90%"

    User -> App: Tap "Charge to 100% for Trip"
    App -> API: POST /vehicles/{id}/settings/charge/trip
    API -> DB: Set one-time charge limit override to 100%
    DB --> API: Confirm override
    API -> App: 200 OK
    App -> User: Display "Trip mode activated. Vehicle will charge to 100%."
end

group Manage Charging Schedules (FR-CHG-005)
    User -> App: Navigate to "Charging Schedules"
    App -> API: GET /vehicles/{id}/schedules
    API -> DB: Query for existing schedules
    DB --> API: Return list of schedules
    API -> App: 200 OK (JSON with schedules)
    App -> User: Display list of existing schedules

    User -> App: Tap "Create New Schedule"
    User -> App: Input details (e.g., "Ready by 7:00 AM")
    App -> API: POST /vehicles/{id}/schedules (body: {type: "ready-by", time: "07:00"})
    API -> DB: Insert new schedule
    DB --> API: Return new schedule ID
    API -> App: 201 Created
    App -> App: Refresh schedule list
    App -> User: Display "Schedule created" confirmation

    User -> App: Tap "Delete" on a schedule
    App -> API: DELETE /vehicles/{id}/schedules/{scheduleId}
    API -> DB: Delete schedule from DB
    alt Deletion successful
        API -> App: 204 No Content
        App -> App: Refresh schedule list
        App -> User: Schedule is removed from the list
    else Deletion failed
        API -> App: 404 Not Found
        App -> User: Display error: "Schedule could not be found."
    end
end

group Find Charging Stations (FR-CHG-006, FR-CHG-007, FR-CHG-008)
    User -> App: Open "Charger Map"
    App -> API: GET /chargers?lat={lat}&lng={lng}
    API -> ChargingStationFinder: Query for nearby chargers
    
    alt Service Responds Successfully
        ChargingStationFinder --> API: Return list of chargers (location, connectors, power, availability)
        alt Chargers Found
            API -> App: 200 OK (JSON with non-empty charger list)
            App -> User: Display map with charger pins
        else No Chargers Found
            API -> App: 200 OK (JSON with empty list)
            App -> User: Display message: "No chargers found nearby."
        end
    else Service is Unavailable
        ChargingStationFinder --> API: 503 Service Unavailable
        API -> App: 503 Service Unavailable
        App -> User: Display error: "Charging station service is currently unavailable."
    end

    User -> App: Apply filters (e.g., Connector: CCS, Power: >150kW)
    App -> API: GET /chargers?lat={lat}&lng={lng}&connector=CCS&power_min=150
    API -> ChargingStationFinder: Query for chargers matching filter criteria
    ChargingStationFinder --> API: Return filtered list of chargers
    API -> App: 200 OK (JSON with filtered charger list)
    App -> User: Display updated map with filtered chargers
end
@enduml