@startuml
!theme plain

title Remote_Controls_v3 Interactions (Security & Reliability Enhanced)
autonumber

actor "User" as User
participant "Mobile App" as App
participant "Auth Service" as AuthService
participant "Cloud API" as API
participant "Vehicle" as Vehicle
database "DB" as DB

skinparam sequence {
    ParticipantBorderColor #555555
    ParticipantBackgroundColor #EEEEEE
    ArrowColor #333333
    LifeLineBorderColor #AAAAAA
}

group Authentication & Authorization (Addressing NFRs)
    User -> App: Enters Credentials and Taps "Login"
    App -> AuthService: POST /auth/token {credentials}
    AuthService -> AuthService: Validate Credentials
    AuthService --> App: 200 OK {authToken}
    App -> App: Store authToken securely
end

group Lock / Unlock Doors (FR-RMC-001, FR-RMC-002, FR-RMC-010)

    User -> App: Taps "Lock"
    App -> API: POST /vehicles/{id}/command/lock
    note right of App: Includes `Authorization: Bearer {authToken}` header

    API -> API: Authorize request using authToken
    API ->> Vehicle: execute_lock()
    API --> App: 202 Accepted (Command Queued)

    alt Successful Execution
        Vehicle --> API: command_success(is_locked: true)
        API -> DB: UPDATE vehicles SET is_locked = true
        API ->> App: PUSH_NOTIFICATION(status: "locked")
        App -> App: Provide Haptic Feedback (FR-RMC-010)
        App --> User: Display "Vehicle Locked"

    else Business Logic Failure (e.g., Door ajar)
        Vehicle --> API: command_failed(reason: "door_ajar")
        API ->> App: PUSH_NOTIFICATION(status: "lock_failed", \nreason: "A door may be open.")
        App --> User: Display "Lock Failed: A door may be open."

    else Network Timeout (QA Rec #4)
        note over API, Vehicle: API waits for response...
        API -> API: Timeout waiting for vehicle response
        API -> DB: UPDATE command_queue SET status = 'timeout'
        API ->> App: PUSH_NOTIFICATION(status: "command_timeout", \nreason: "Vehicle is unresponsive.")
        App --> User: Display "Command Failed: Vehicle is offline."
    end
end

group Climate Preconditioning (FR-RMC-003 to FR-RMC-007)

    User -> App: Taps "Start Climate" \n(configures settings)
    App -> API: GET /vehicles/{id}/state
    API -> DB: SELECT is_plugged_in, battery_level FROM vehicles
    DB --> API: is_plugged_in: false, battery_level: 35%
    API --> App: 200 OK {state}

    opt FR-RMC-007: Vehicle is not plugged in
        App --> User: Display Warning: "Vehicle not plugged in.\nThis will consume battery range. Continue?"
        User -> App: Confirms "Continue"
    end

    App -> API: POST /vehicles/{id}/command/precondition \n{climate_settings}
    note left of API
        // Improved DTO to support various element types (QA Rec #2)
        {
          "target_temp": 21,
          "heated_elements": {
            "seats_front": "high",
            "steering_wheel": "on"
          },
          "defrosters": {
            "front": "on", "rear": "off"
          }
        }
    endnote

    alt Sufficient Battery for Preconditioning
        API ->> Vehicle: execute_precondition(climate_settings)
        API --> App: 202 Accepted

        Vehicle --> API: command_success(hvac_status: "on")
        API -> DB: UPDATE vehicles SET hvac_status = 'on', ...
        API ->> App: PUSH_NOTIFICATION(status: "climate_on")
        App --> User: Display "Climate Control Activated"

    else Business Logic Failure (Critically Low Battery)
        API --> App: 409 Conflict {error: "critically_low_battery"}
        App --> User: Display "Command Failed:\nBattery is critically low."
    end
end

group Open Trunk / Frunk (FR-RMC-008)

    User -> App: Taps "Open Frunk"
    App -> API: POST /vehicles/{id}/command/open_frunk

    alt Pre-condition Met
        note right of API: Pre-condition check against Vehicle State Machine\n(current state must be 'PARKED') (QA Rec #1)
        API ->> Vehicle: execute_open_frunk()
        API --> App: 202 Accepted

        Vehicle --> API: command_success(frunk_open: true)
        API -> DB: UPDATE vehicles SET frunk_open = true
        API ->> App: PUSH_NOTIFICATION(status: "frunk_open")
        App --> User: Display "Frunk is Open"

    else Business Logic Failure (Pre-condition not met)
        API -> API: Pre-condition check failed (state is 'DRIVING')
        API --> App: 400 Bad Request {error: "vehicle_in_motion"}
        App --> User: Display "Cannot open while vehicle is in motion."
    end
end

group Honk Horn / Flash Lights (FR-RMC-009)

    User -> App: Taps "Honk & Flash"
    App -> API: POST /vehicles/{id}/command/honk_flash

    alt Successful Command
        API ->> Vehicle: execute_honk_flash()
        API --> App: 202 Accepted

        Vehicle --> API: command_success()
        API ->> App: PUSH_NOTIFICATION(status: "honk_flash_activated")
        App --> User: Display "Horn & Lights Activated"

    else API / Vehicle Communication Error
        API --> App: 503 Service Unavailable
        App --> User: Display "Command Failed. Cannot reach vehicle."
    end
end
@enduml