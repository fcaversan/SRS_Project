@startuml
!theme plain
title Charging_Management_v1 Interactions

autonumber

actor User
participant App
participant API
database DB

group Remote Charging Control (FR-CHG-001, FR-CHG-002)

    User -> App: Tap "Start Charging"
    App -> API: POST /vehicles/{id}/charge/start
    API -> API: Validate vehicle state (plugged in, etc.)
    alt Vehicle is ready to charge
        API -> App: 200 OK (Charging Started)
        App -> User: Display "Charging session started"
    else Vehicle not ready (e.g., not plugged in)
        API -> App: 409 Conflict (Error: Not plugged in)
        App -> User: Display error: "Vehicle is not plugged into a compatible charger."
    end

    ...5 minutes later...

    User -> App: Tap "Stop Charging"
    App -> API: POST /vehicles/{id}/charge/stop
    alt Command successful
        API -> App: 200 OK (Charging Stopped)
        App -> User: Display "Charging session stopped"
    else Command failed on server/vehicle
        API -> App: 500 Internal Server Error
        App -> User: Display error: "Failed to stop charging session."
    end
end

group Monitor Active Charging Session (FR-CHG-003)
    User -> App: View charging screen
    loop Periodically update status
        App -> API: GET /vehicles/{id}/charge/status
        alt API responds with data
            API -> App: 200 OK (JSON: {soc, time_to_full, rate_kw, voltage, amperage})
            App -> User: Update display with SoC, ETA, rate, etc.
        else API request fails
            API -> App: 503 Service Unavailable
            App -> User: Display stale data with "Could not refresh status" message
        end
    end
end

group Manage Charging Settings (FR-CHG-004)
    User -> App: Open "Charging Settings"
    App -> API: GET /vehicles/{id}/settings/charge
    API -> DB: Query for current charge limit
    DB --> API: Return current setting (e.g., 80%)
    API -> App: 200 OK (JSON: {daily_limit: 80})
    App -> User: Display charge limit slider (default 80%)
    
    User -> App: Set new charge limit (e.g., 90%)
    App -> API: PUT /vehicles/{id}/settings/charge (body: {daily_limit: 90})
    API -> DB: Update charge limit for vehicle
    DB --> API: Confirm update
    alt Update successful
        API -> App: 200 OK
        App -> User: Display "Charge limit updated to 90%"
    else Update failed (e.g., invalid value)
        API -> App: 400 Bad Request
        App -> User: Display error: "Invalid limit. Please choose a value between 50-100%."
    end
end

group Manage Charging Schedules (FR-CHG-005)
    User -> App: Navigate to "Charging Schedules"
    App -> API: GET /vehicles/{id}/schedules
    API -> DB: Query for existing schedules
    DB --> API: Return list of schedules
    API -> App: 200 OK (JSON with schedules)
    App -> User: Display list of existing schedules

    User -> App: Tap "Create New Schedule"
    User -> App: Input details (e.g., "Ready by 7:00 AM")
    App -> API: POST /vehicles/{id}/schedules (body: {type: "ready-by", time: "07:00"})
    API -> DB: Insert new schedule
    DB --> API: Return new schedule ID
    alt Creation successful
        API -> App: 201 Created
        App -> App: Refresh schedule list from API
        App -> User: Display "Schedule created" confirmation
    else Creation failed (e.g., conflict)
        API -> App: 409 Conflict (Error: Overlapping schedule)
        App -> User: Display error: "This schedule conflicts with an existing one."
    end

    User -> App: Tap "Delete" on an existing schedule
    App -> API: DELETE /vehicles/{id}/schedules/{scheduleId}
    API -> DB: Delete schedule from DB
    alt Deletion successful
        API -> App: 204 No Content
        App -> App: Refresh schedule list from API
        App -> User: Schedule is removed from the list
    else Deletion failed
        API -> App: 404 Not Found
        App -> User: Display error: "Schedule could not be found."
    end
end

group Find Charging Stations (FR-CHG-006, FR-CHG-007, FR-CHG-008)
    User -> App: Open "Charger Map"
    App -> API: GET /chargers/map?location={lat,lng}
    alt Chargers found
        API -> DB: Query for nearby chargers with real-time availability
        DB --> API: Return list of chargers (location, type, power, availability)
        API -> App: 200 OK (JSON with charger list)
        App -> User: Display map with charger pins
    else API error or no chargers found
        API -> App: 500 Server Error or 200 OK (empty list)
        App -> User: Display error: "Could not load chargers or none found nearby."
    end

    User -> App: Apply filters (e.g., Connector: CCS, Power: >150kW)
    App -> API: GET /chargers/map?location={lat,lng}&type=CCS&power_min=150
    API -> DB: Query for chargers matching filter criteria
    DB --> API: Return filtered list of chargers
    API -> App: 200 OK (JSON with filtered charger list)
    App -> User: Display updated map with filtered chargers
end

@enduml