@startuml

skinparam classAttributeIconSize 0
hide empty members

' User and Core Domain Entities
class User {
  + userId: UUID
}

class Vehicle {
  - vehicleId: UUID
  - vin: String
  - isPluggedIn: boolean
  - currentSoC: int
}

class ChargingSettings {
  - maxChargeLimit: int
  - defaultDailyLimit: int = 80
  - oneTimeFullCharge: boolean
}

class ChargingSession {
  - sessionId: UUID
  - startTime: DateTime
  - endTime: DateTime
  - currentSoC: int
  - estimatedTimeToCompletion: Duration
  - currentRateKW: float
  - suppliedVoltage: float
  - suppliedAmperage: float
  - state: ChargingSessionState
}

note bottom of ChargingSession
  The lifecycle of this entity is formally defined
  in a dedicated State Machine Diagram.
end note

class ChargingSchedule {
  - scheduleId: UUID
  - startTime: Time
  - readyByTime: Time
  - isActive: boolean
}

class ChargingStation {
  - stationId: UUID
  - location: Coordinates
  - networkOperator: String
  - isAvailable: boolean
  + availabilityLastUpdated: DateTime
  + supportedConnectors: List<ConnectorType>
  + maxPowerLevelKW: PowerLevel
}

' ===============================================
' IMPROVEMENT: Decomposed Facade into granular services
' to adhere to Single Responsibility Principle (SRP).
' ===============================================

' Application Facade
class ChargingManager {
  ' This class now delegates to specialized services.
}

note right of ChargingManager
  Serves as the primary application service layer facade,
  used by API controllers to orchestrate charging-related operations.
end note

' Specialized Application Services
package "Application Services" {
  class ChargingSessionService {
    + startRemoteCharging(userId: UUID, vehicleId: UUID): ChargingSession
    + stopRemoteCharging(userId: UUID, sessionId: UUID): void
    + getChargingStatus(userId: UUID, sessionId: UUID): ChargingStatusDTO
  }

  class ChargingSettingsService {
    + setChargingLimit(userId: UUID, vehicleId: UUID, limit: int, isForTrip: boolean): void
  }

  class ChargingScheduleService {
    + createSchedule(userId: UUID, vehicleId: UUID, scheduleDetails: ScheduleDTO): ChargingSchedule
    + editSchedule(userId: UUID, scheduleId: UUID, scheduleDetails: ScheduleDTO): void
    + deleteSchedule(userId: UUID, scheduleId: UUID): void
  }

  class ChargingStationFinder {
    + findStations(criteria: FilterCriteria): List<ChargingStation>
  }
}

' Repository Interface
interface IChargingStationRepository <<interface>> {
  + find(criteria: FilterCriteria): List<ChargingStation>
}


' Value Objects & DTOs
package "Data Transfer & Value Objects" {
  class Coordinates {
    + latitude: double
    + longitude: double
  }

  class FilterCriteria {
    + centerPoint: Coordinates
    + searchRadiusMeters: int
    + connectorTypes: List<ConnectorType>
    + minPowerLevel: PowerLevel
  }

  class ChargingStatusDTO {
    + currentSoC: int
    + estimatedTimeToCompletion: Duration
    + currentChargingRateKW: float
    + suppliedVoltage: float
    + suppliedAmperage: float
  }

  class ScheduleDTO {
    + startTime: Time
    + readyByTime: Time
    + isActive: boolean
  }
}

' Enumerations
package "Enumerations" {
  enum ChargingSessionState {
    INITIALIZED
    AUTHENTICATING
    CHARGING
    PAUSED
    COMPLETED
    FAULTED
  }

  enum ConnectorType {
    TYPE_1
    TYPE_2
    CCS
    CHADEMO
    TESLA_NACS
  }

  enum PowerLevel {
    LEVEL_1_AC
    LEVEL_2_AC
    DC_FAST_50KW
    DC_FAST_150KW
    DC_FAST_350KW
  }
}


' Relationships

' Top-level interaction
User ..> ChargingManager

' Facade delegates to specialized services (Composition)
ChargingManager "1" *-- "1" ChargingSessionService
ChargingManager "1" *-- "1" ChargingSettingsService
ChargingManager "1" *-- "1" ChargingScheduleService
ChargingManager "1" *-- "1" ChargingStationFinder

' Service to Repository relationship (Dependency Inversion)
ChargingStationFinder "1" o-- "1" IChargingStationRepository

' Service to Domain/DTO dependencies
ChargingSessionService ..> Vehicle
ChargingSessionService ..> ChargingSession
ChargingSessionService ..> ChargingStatusDTO

ChargingSettingsService ..> Vehicle

ChargingScheduleService ..> Vehicle
ChargingScheduleService ..> ChargingSchedule
ChargingScheduleService ..> ScheduleDTO

ChargingStationFinder ..> FilterCriteria
ChargingStationFinder ..> ChargingStation

' Core Domain Relationships
User "1" o-- "1..*" Vehicle
Vehicle "1" *-- "1" ChargingSettings
Vehicle "1" o-- "0..*" ChargingSession
Vehicle "1" *-- "0..*" ChargingSchedule

ChargingStation "1" o-- "0..*" ChargingSession
ChargingStation "1" *-- "1" Coordinates

ChargingSession *-- ChargingSessionState

@enduml