@startuml

skinparam classAttributeIconSize 0
hide empty members

' ===============================================
' IMPROVEMENT: Key architectural and domain model refinements
' based on QA feedback from Iteration 5.
'
' 1. Clarified Vehicle-Session relationship with an explicit 'currentSession'.
' 2. Made external data sources explicit with an 'INetworkOperatorGateway'.
' 3. Added 'dataSource' to ChargingStation for data provenance.
' 4. Improved clarity of attribute names and added clarifying notes.
' ===============================================

' User and Core Domain Entities
class User {
  + userId: UUID
}

class Vehicle {
  - vehicleId: UUID
  - vin: String
  - isPluggedIn: boolean
  - currentSoC: int
}

class ChargingSettings {
  - maxChargeLimit: int
  - defaultDailyLimit: int = 80
  ' IMPROVEMENT: Renamed for clarity, per FR-CHG-004.
  - isOneTimeFullChargeActive: boolean
}

class ChargingSession {
  - sessionId: UUID
  - startTime: DateTime
  - endTime: DateTime
  - currentSoC: int
  - estimatedTimeToCompletion: Duration
  - currentRateKW: float
  - suppliedVoltage: float
  - suppliedAmperage: float
  - state: ChargingSessionState
}

note bottom of ChargingSession
  Behavior is governed by a dedicated
  State Machine Diagram, which defines all
  valid transitions between states.
end note

class ChargingSchedule {
  - scheduleId: UUID
  - startTime: Time
  - readyByTime: Time
  - isActive: boolean
}

note bottom of ChargingSchedule
  A schedule can be defined by either a
  start time or a desired ready-by time.
end note

class ChargingStation {
  - stationId: UUID
  - location: Coordinates
  - networkOperator: String
  - isAvailable: boolean
  + availabilityLastUpdated: DateTime
  ' IMPROVEMENT: Added to track data provenance per FR-CHG-008.
  + dataSource: String
  + supportedConnectors: List<ConnectorType>
  + maxPowerLevelKW: PowerLevel
}

' Application Services
package "Application Services" {
  class ChargingManager {
    ' Facade that orchestrates specialized services.
  }

  note right of ChargingManager
    Serves as the primary application service layer facade,
    used by API controllers to orchestrate charging-related operations.
  end note

  class ChargingSessionService {
    + startRemoteCharging(userId: UUID, vehicleId: UUID): ChargingSession
    + stopRemoteCharging(userId: UUID, sessionId: UUID): void
    + getChargingStatus(userId: UUID, sessionId: UUID): ChargingStatusDTO
  }

  class ChargingSettingsService {
    + setChargingLimit(userId: UUID, vehicleId: UUID, limit: int, isForTrip: boolean): void
  }

  class ChargingScheduleService {
    + createSchedule(userId: UUID, vehicleId: UUID, scheduleDetails: ScheduleDTO): ChargingSchedule
    + editSchedule(userId: UUID, scheduleId: UUID, scheduleDetails: ScheduleDTO): void
    + deleteSchedule(userId: UUID, scheduleId: UUID): void
  }

  class ChargingStationFinder {
    + findStations(criteria: FilterCriteria): List<ChargingStation>
  }
}

' Infrastructure & Repository Interfaces
package "Infrastructure Interfaces" {
  interface IChargingStationRepository <<interface>> {
    + findByCriteria(criteria: FilterCriteria): List<ChargingStation>
    + save(stations: List<ChargingStation>): void
  }

  ' IMPROVEMENT: Explicitly models interaction with third-party APIs
  ' to address real-time availability requirement (FR-CHG-008).
  interface INetworkOperatorGateway <<interface>> {
    + fetchRealTimeData(area: BoundingBox): List<StationDataDTO>
  }
}


' Value Objects & DTOs
package "Data Transfer & Value Objects" {
  class Coordinates {
    + latitude: double
    + longitude: double
  }

  class FilterCriteria {
    + centerPoint: Coordinates
    + searchRadiusMeters: int
    + connectorTypes: List<ConnectorType>
    + minPowerLevel: PowerLevel
  }

  class ChargingStatusDTO {
    + currentSoC: int
    + estimatedTimeToCompletion: Duration
    + currentChargingRateKW: float
    + suppliedVoltage: float
    + suppliedAmperage: float
  }

  class ScheduleDTO {
    + startTime: Time
    + readyByTime: Time
    + isActive: boolean
  }

  ' Introduced to support the INetworkOperatorGateway interface.
  class StationDataDTO {
    + operatorStationId: String
    + location: Coordinates
    + isAvailable: boolean
    + lastUpdated: DateTime
  }

  ' Helper for INetworkOperatorGateway
  class BoundingBox {
    + topLeft: Coordinates
    + bottomRight: Coordinates
  }
}

' Enumerations
package "Enumerations" {
  enum ChargingSessionState {
    INITIALIZED
    AUTHENTICATING
    CHARGING
    PAUSED
    COMPLETED
    FAULTED
  }

  enum ConnectorType {
    TYPE_1
    TYPE_2
    CCS
    CHADEMO
    TESLA_NACS
  }

  enum PowerLevel {
    LEVEL_1_AC
    LEVEL_2_AC
    DC_FAST_50KW
    DC_FAST_150KW
    DC_FAST_350KW
  }
}


' === Relationships ===

' Top-level interaction
User ..> ChargingManager

' Facade delegates to specialized services (Composition)
ChargingManager "1" *-- "1" ChargingSessionService
ChargingManager "1" *-- "1" ChargingSettingsService
ChargingManager "1" *-- "1" ChargingScheduleService
ChargingManager "1" *-- "1" ChargingStationFinder

' Service to Infrastructure dependencies (DIP)
ChargingStationFinder "1" o-- "1" IChargingStationRepository
' IMPROVEMENT: Finder service now depends on external gateway for live data.
ChargingStationFinder "1" o-- "1" INetworkOperatorGateway

' Service to Domain/DTO dependencies
ChargingSessionService ..> Vehicle
ChargingSessionService ..> ChargingSession
ChargingSessionService ..> ChargingStatusDTO

ChargingSettingsService ..> Vehicle

ChargingScheduleService ..> Vehicle
ChargingScheduleService ..> ChargingSchedule
ChargingScheduleService ..> ScheduleDTO

ChargingStationFinder ..> FilterCriteria
ChargingStationFinder ..> ChargingStation
INetworkOperatorGateway ..> StationDataDTO
INetworkOperatorGateway ..> BoundingBox

' Core Domain Relationships
User "1" o-- "1..*" Vehicle
Vehicle "1" *-- "1" ChargingSettings
Vehicle "1" *-- "0..*" ChargingSchedule

' IMPROVEMENT: Explicitly models the current session vs historical sessions
' to resolve ambiguity in state checking (per QA feedback).
Vehicle "1" -> "0..1" ChargingSession : > has current
Vehicle "1" o-- "0..*" ChargingSession : has history

ChargingStation "1" o-- "0..*" ChargingSession
ChargingStation "1" *-- "1" Coordinates

ChargingSession *-- ChargingSessionState

@enduml