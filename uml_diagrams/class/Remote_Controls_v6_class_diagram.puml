@startuml

' Style settings for better readability
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam shadowing false
skinparam roundcorner 10
skinparam defaultFontName "Segoe UI"
skinparam class {
    BackgroundColor White
    ArrowColor #262626
    BorderColor #262626
}
skinparam interface {
    BackgroundColor lightgreen
    ArrowColor #262626
    BorderColor #262626
}

' ---------- Enumerations for States, Types, and Locations ----------
enum LockState {
  LOCKED
  UNLOCKED
}

enum ComponentState {
  ACTIVE
  INACTIVE
}

enum ClimateSystemState {
    OFF
    ACTIVE
    PRECONDITIONING
}

enum TrunkLocation {
  FRONT
  REAR
}

enum DefrosterLocation {
  FRONT
  REAR
}

enum ElementLocation {
    DRIVER_SEAT
    PASSENGER_SEAT
    REAR_LEFT_SEAT
    REAR_RIGHT_SEAT
    STEERING_WHEEL
}

enum PlugStatus {
    PLUGGED_IN
    UNPLUGGED
}

enum CommandStatus {
    SUCCESS
    FAILURE_AUTHENTICATION
    FAILURE_VEHICLE_UNREACHABLE
    FAILURE_INVALID_PRECONDITION
    FAILURE_TIMEOUT
    FAILURE_NOT_EQUIPPED
}

enum VehicleState {
    PARKED
    DRIVING
    CHARGING
}
note left
  **IMPROVEMENT (QA Gap #1):**
  The Vehicle's state attribute is designed to be
  governed by a formal State Machine Diagram.
  This machine will enforce which commands
  are permissible in each state (e.g., PARKED),
  formalizing the system's business rules.
end note

enum HeatingLevel {
    OFF
    LOW
    MEDIUM
    HIGH
}

enum AlertType {
    HONK
    FLASH_LIGHTS
}
note right
  **IMPROVEMENT (QA Gap #3):**
  Added to provide specific alert types
  for the refined ExteriorAlertSystem,
  making requests more explicit than a
  generic 'trigger' command.
end note


' ---------- Interfaces for Abstraction Refinement ----------
interface IToggleable <<(I,lightgreen)>> {
  + activate(): void
  + deactivate(): void
}

interface ILevelAdjustable <<(I,lightgreen)>> {
  + setLevel(level: HeatingLevel): void
  + getLevel(): HeatingLevel
}


' ---------- Data Transfer Objects (DTOs) and Value Objects ----------
class AuthToken <<(V,orchid) Value Object>> {
  + tokenValue: string
  + expiryDate: datetime
}

class CommandResponse <<(V,orchid) Value Object>> {
    + status: CommandStatus
    + message: string
}

class ElementSetting <<(D,orchid) Data>> {
    + active: bool
    + level: HeatingLevel
}

class ClimateSettings <<(D,orchid) Data>> {
    + targetTemperature: float
    + heatedElements: map<ElementLocation, ElementSetting>
    + defrosters: map<DefrosterLocation, bool>
}

class VehicleCapabilities <<(D,orchid) Data>> {
    + hasHeatedSteeringWheel: bool
    + hasHeatedRearSeats: bool
    + supportedSeatHeatingLevels: list<HeatingLevel>
}
note top
  **IMPROVEMENT (QA Gap #4):**
  Supports dynamic UI generation by allowing the mobile
  app to query the vehicle's specific equipment. This
  provides the model support for the recommended
  'feature discovery' interaction sequence.
end note


' ---------- Services and Main Classes ----------
class AuthenticationService {
  + validateToken(token: AuthToken): bool
}

class MobileDevice {
  + deviceID: string
  --
  + getVehicleCapabilities(authToken: AuthToken, vehicleID: string): VehicleCapabilities
  + sendLockRequest(authToken: AuthToken, vehicleID: string): CommandResponse
  + sendUnlockRequest(authToken: AuthToken, vehicleID: string): CommandResponse
  + sendClimateRequest(authToken: AuthToken, vehicleID: string, settings: ClimateSettings): CommandResponse
  + sendTrunkRequest(authToken: AuthToken, vehicleID: string, location: TrunkLocation): CommandResponse
  + sendAlertRequest(authToken: AuthToken, vehicleID: string, type: AlertType): CommandResponse
  + displayWarning(message: string): void
  + triggerHapticFeedback(): void
}

class RemoteControlSystem {
  --
  + getVehicleCapabilities(authToken: AuthToken, vehicleID: string): VehicleCapabilities
  + processLockRequest(authToken: AuthToken, vehicleID: string): CommandResponse
  + processUnlockRequest(authToken: AuthToken, vehicleID: string): CommandResponse
  + processClimateRequest(authToken: AuthToken, vehicleID: string, settings: ClimateSettings): CommandResponse
  + processTrunkRequest(authToken: AuthToken, vehicleID: string, location: TrunkLocation): CommandResponse
  + processAlertRequest(authToken: AuthToken, vehicleID: string, type: AlertType): CommandResponse
}

class Vehicle {
  + vin: string
  + model: string
  - state: VehicleState
  --
  + getState(): VehicleState
  + getCapabilities(): VehicleCapabilities
}

' ---------- Vehicle Subsystem Classes ----------

class DoorSystem {
  - lockState: LockState
  --
  + lock(): void
  + unlock(): void
  + getLockState(): LockState
}

class ClimateControlSystem {
  - state: ClimateSystemState
  - targetTemperature: float
  --
  + activate(): void
  + deactivate(): void
  + setTargetTemperature(temp: float): void
}

abstract class HeatedElement {
  # location: ElementLocation
  # state: ComponentState
  --
  + getState(): ComponentState
}

class HeatedSeat {
  - heatingLevel: HeatingLevel
  --
  + activate(): void
  + deactivate(): void
  + setLevel(level: HeatingLevel): void
  + getLevel(): HeatingLevel
}

class HeatedSteeringWheel {
  + activate(): void
  + deactivate(): void
}

class Defroster {
  - location: DefrosterLocation
  - state: ComponentState
  --
  + activate(): void
  + deactivate(): void
}

class Trunk {
    - location: TrunkLocation
    - isOpen: bool
    --
    + open(): void
    + close(): void
}

class ExteriorAlertSystem {
  --
  + honkHorn(): void
  + flashLights(): void
}
note right
  **IMPROVEMENT (QA Gap #3):**
  Replaced generic `triggerAlert()` with
  specific methods that directly map to
  FR-RMC-009, improving clarity and
  removing ambiguity.
end note


class PowerSystem {
    - plugStatus: PlugStatus
    --
    + isPluggedIn(): bool
}


' ---------- Relationships and Multiplicity ----------

' System-level relationships
RemoteControlSystem "1" -- "0..*" MobileDevice : communicates with >
RemoteControlSystem "1" -- "0..*" Vehicle : controls >
RemoteControlSystem "1" --> "1" AuthenticationService : uses

' Vehicle composition
Vehicle "1" *-- "1" DoorSystem
Vehicle "1" *-- "1" ClimateControlSystem
Vehicle "1" *-- "2" Trunk
Vehicle "1" *-- "1" ExteriorAlertSystem
Vehicle "1" *-- "1" PowerSystem
Vehicle "1" *-- "1" VehicleCapabilities

' ClimateControlSystem composition
ClimateControlSystem "1" *-- "0..*" HeatedElement
ClimateControlSystem "1" *-- "2" Defroster

' HeatedElement abstraction refinement
IToggleable <|.. HeatedElement
ILevelAdjustable <|.. HeatedSeat
HeatedElement <|-- HeatedSeat
HeatedElement <|-- HeatedSteeringWheel

' Dependency on DTOs and Value Objects
RemoteControlSystem ..> CommandResponse
MobileDevice ..> CommandResponse
RemoteControlSystem ..> ClimateSettings
MobileDevice ..> ClimateSettings
MobileDevice ..> AuthToken
RemoteControlSystem ..> AuthToken
ClimateSettings ..> ElementSetting
ElementSetting ..> HeatingLevel
MobileDevice ..> AlertType
RemoteControlSystem ..> AlertType
MobileDevice ..> VehicleCapabilities
RemoteControlSystem ..> VehicleCapabilities

@enduml