@startuml
'ITERATION 4: Improved based on QA Validation Feedback
'Focus: Added authentication, explicit state transitions, data freshness indicators, and an interactive loop.

title Charging Management Workflow (Iteration 4)

skinparam activity {
    BackgroundColor #LightBlue
    BorderColor #181818
    ArrowColor #181818
    AttributeFontColor #181818
}

start

:User opens Charging Management screen;

:Verify user authentication;
if (User is authenticated?) then (yes)
    ' Loop until user exits
    repeat
        :Display Charging Management dashboard;
        if (Select 'Remote Control') then (yes)
            if (Is charging session active?) then (yes)
                :Send 'Stop Charge' command to vehicle;
                if (Command acknowledged by vehicle?) then (yes)
                    :Update session state to 'STOPPED';
                    :Display 'Charging Stopped' confirmation;
                else (no)
                    :Display error: "Failed to communicate with vehicle";
                endif
            else (no)
                if (Is vehicle plugged into a compatible charger?) then (yes)
                    :Send 'Start Charge' command to vehicle;
                    if (Command acknowledged by vehicle?) then (yes)
                        :Update session state to 'CHARGING';
                        :Display 'Charging Started' confirmation;
                    else (no)
                        :Display error: "Failed to start charging. Please try again.";
                    endif
                else (no)
                    :Display error: "Vehicle not plugged in or charger incompatible";
                endif
            endif

        else if (Select 'View Active Session') then (yes)
            if (Charging session is active?) then (yes)
                :Display Session Status (State, SoC, ETA, Rate, Voltage/Amperage);
            else (no)
                :Display "No active charging session";
            endif

        else if (Select 'Manage Settings') then (yes)
            partition "Charging Settings" {
                if (Select 'Set Charge Limit') then (yes)
                    :Display interface with default 80% limit;
                    if (User selects 'Charge to 100% for trip'?) then (yes)
                        :Set one-time charge limit to 100%;
                    else (no)
                        :Allow user to set a new maximum percentage;
                        :Save new charge limit;
                    endif
                    :Display 'Limit updated' confirmation;
                else if (Select 'Manage Schedules') then (yes)
                    switch (User Action)
                    case (Create New Schedule)
                        :Define start time or ready-by time;
                        :Save new schedule;
                        :Display 'Schedule created' confirmation;
                    case (Edit Existing Schedule)
                        :Select a schedule to edit;
                        :Modify schedule details;
                        :Save updated schedule;
                        :Display 'Schedule updated' confirmation;
                    case (Delete Schedule)
                        :Select a schedule to delete;
                        :Confirm deletion;
                        :Delete selected schedule;
                        :Display 'Schedule deleted' confirmation;
                    endswitch
                endif
            }

        else if (Select 'Find Stations') then (yes)
            partition "Charging Station Finder" {
                :Request station data from service;
                if (Data service responds?) then (yes)
                    :Display map of charging stations;
                    if (User applies filters?) then (yes)
                        :Filter by connector type & power level;
                        :Update map with filtered results;
                    endif
                    fork
                        :For each visible station, fetch real-time availability;
                    fork again
                        :Display status (e.g., 'Available', 'In Use')
and data freshness (e.g., 'Updated <1 min ago') on map pins;
                    end fork
                else (no)
                    :Display error: "Charging station service is currently unavailable";
                endif
            }
        else (User Exits Screen)
            break
        endif
    repeat while () is ()
else (no)
    :Display "Authentication required";
    stop
endif

stop

@enduml