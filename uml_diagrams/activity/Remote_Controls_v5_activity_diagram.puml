@startuml
!theme spacelab
title Iteration 5: Refined Remote Control Activity Diagram (Post-QA)

partition "User (Mobile App)" {
    start
    :User selects remote command;
}

partition "Remote Control System (Cloud API)" {
    note right: **QA Rec #2:** Participant renamed for clarity.
    :Authenticate User and Authorize Command;
    note left
        **QA Rec #4:** Triggered by an authenticated
        HTTPS request to the cloud API.
    end note
    if (Authorization successful?) then (yes)
        ' Proceed to command switch
    else (no)
        :Format Authorization Failure Payload;
        -> Send Push Notification;
        stop
    endif

    switch (Selected Remote Command?)
    case (Lock / Unlock Doors)
        :Send Lock/Unlock command to Vehicle;
        fork
            :Await response from Vehicle;
            if (Response is Success?) then (yes)
                :Format Lock/Unlock Success Payload;
            else (no)
                :Format Generic Failure Payload;
            endif
        fork again
            :Wait for Timeout;
            :Format Timeout Payload;
        end fork
        -> Send Push Notification;

    case (Climate Preconditioning)
        :User configures Climate Settings;
        :Query Vehicle State Machine;
        note left
            **QA Rec #1:** State machine is queried
            as a precondition for multiple actions,
            formalizing state-based command eligibility.
        end note
        if (State is PARKED?) then (yes)
            :Request Power Source Status;
            if (Vehicle is plugged in?) then (yes)
                ' Proceed directly
            else (no)
                :Display battery consumption warning to User;
                if (User confirms to proceed?) then (yes)
                    ' Proceed to send command
                else (no)
                    :Cancel climate action;
                    stop
                endif
            endif
            :Send climate command with settings;
            fork
                :Await response from Vehicle;
                switch (Vehicle Response?)
                case (Success)
                    :Format Climate Success Payload;
                case (Invalid Parameter)
                    :Format Invalid Parameter Payload;
                case (Generic Failure)
                    :Format Generic Failure Payload;
                endswitch
            fork again
                :Wait for Timeout;
                :Format Timeout Payload;
            end fork
            -> Send Push Notification;
        else (no)
            :Format Vehicle Not Stationary Payload;
            -> Send Push Notification;
        endif

    case (Open Trunk / Frunk)
        :User selects Front or Rear Trunk;
        :Query Vehicle State Machine;
        if (State is PARKED?) then (yes)
            :Send Open Trunk command to Vehicle;
            fork
                :Await response from Vehicle;
                if (Response is Success?) then (yes)
                    :Format Trunk Success Payload;
                else (no)
                    :Format Generic Failure Payload;
                endif
            fork again
                :Wait for Timeout;
                :Format Timeout Payload;
            end fork
            -> Send Push Notification;
        else (no)
            :Format Vehicle Not Stationary Payload;
            -> Send Push Notification;
        endif

    case (Honk Horn & Flash Lights)
        :Query Vehicle State Machine;
        note left
            **QA Rec #1:** State machine check applied
            consistently for safety-related actions.
        end note
        if (State is PARKED?) then (yes)
            :Send Honk & Flash command to Vehicle;
            fork
                :Await response from Vehicle;
                if (Response is Success?) then (yes)
                    :Format Honk/Flash Success Payload;
                else (no)
                    :Format Generic Failure Payload;
                endif
            fork again
                :Wait for Timeout;
                :Format Timeout Payload;
            end fork
            -> Send Push Notification;
        else (no)
            :Format Vehicle Not Stationary Payload;
            -> Send Push Notification;
        endif
    endswitch
}

partition "Vehicle (Onboard ECU)" {
    split
        :Receive Lock/Unlock command;
        :Actuate door locks;
        :Send Success/Failure Response;
    split again
        :Receive Power Status Request;
        :Report Power Source (PluggedIn/Battery);
    split again
        :Receive Climate command;
        :Validate settings against vehicle hardware config;
        note right
            **QA Rec #3:** Added granular error check for
            commands with invalid parameters (e.g., a feature
            the vehicle is not equipped with).
        end note
        if (Settings are valid?) then (yes)
            :Activate HVAC system components;
            :Send Success/Failure Response;
        else (no)
            :Send InvalidParameter Response;
        endif
    split again
        :Receive Vehicle State Request;
        :Report Current State (e.g., PARKED);
    split again
        :Receive Open Trunk command;
        :Actuate trunk latch;
        :Send Success/Failure Response;
    split again
        :Receive Honk & Flash command;
        :Activate horn and exterior lights;
        :Send Success/Failure Response;
    end split
}

partition "Remote Control System (Cloud API)" {
    :Send Push Notification;
    note left
        **QA Rec #4:** Explicitly modeling the translation
        of internal system events into asynchronous
        push notifications for the mobile client.
    end note
}

partition "User (Mobile App)" {
    ->:Receive and Process Notification;
    switch (Notification Content?)
    case (Lock/Unlock Success)
        :Provide haptic feedback;
        :Display updated door status;
    case (Climate Success)
        :Display updated climate status;
    case (Trunk Success)
        :Display updated trunk status;
    case (Honk/Flash Success)
        :Display "Command Sent" confirmation;
    case (Vehicle Not Stationary)
        :Display Error: "Vehicle must be parked to perform this action.";
    case (Authorization Failure)
        :Display "Authorization Failed" error;
    case (Invalid Parameter)
        :Display Error: "Action failed. Feature not available on this vehicle.";
        note left: **QA Rec #3:** New specific error message.
    case (Generic Command Failure)
        :Display "Command Failed. Vehicle did not respond as expected.";
    case (Request Timeout)
        :Display "Request Timed Out. Please check connectivity.";
    endswitch

    :End remote session;
    stop
}
@enduml